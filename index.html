// FULLSTACK DATING APP (React + Firebase)
// ==================================
// FIXED VERSION ‚Äì Firebase initialized safely
// Fitur:
// - Login & Register (Firebase Auth)
// - Like & Match
// - Chat realtime (UI WhatsApp-style)
// - Algoritma kecocokan & AI scoring
// - Mobile-ready architecture

import { useEffect, useState } from "react";
import { initializeApp, getApps } from "firebase/app";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
} from "firebase/auth";
import {
  getFirestore,
  collection,
  doc,
  setDoc,
  getDoc,
  addDoc,
  query,
  where,
  onSnapshot,
  serverTimestamp,
} from "firebase/firestore";

// üî• Firebase Config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};

// ‚úÖ SAFE INITIALIZATION (prevents auth not registered error)
const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const auth = getAuth(app);
const db = getFirestore(app);

export default function DatingApp() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [profiles, setProfiles] = useState([]);
  const [current, setCurrent] = useState(0);

  // üîê Auth state listener (SAFE)
  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsub();
  }, []);

  // üîê Auth actions
  const login = async () => {
    await signInWithEmailAndPassword(auth, email, password);
  };

  const register = async () => {
    const res = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, "users", res.user.uid), {
      email,
      age: 25,
      city: "Jakarta",
      interests: ["travel", "music"],
      createdAt: serverTimestamp(),
    });
  };

  // üîç Load profiles
  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, "users"), where("email", "!=", user.email));
    const unsub = onSnapshot(q, (snap) => {
      setProfiles(snap.docs.map((d) => ({ id: d.id, ...d.data() })));
    });
    return () => unsub();
  }, [user]);

  // ‚ù§Ô∏è Like & Match
  const likeUser = async (targetId) => {
    if (!user) return;

    await setDoc(doc(db, "likes", `${user.uid}_${targetId}`), {
      from: user.uid,
      to: targetId,
      createdAt: serverTimestamp(),
    });

    const matchCheck = await getDoc(doc(db, "likes", `${targetId}_${user.uid}`));
    if (matchCheck.exists()) {
      await setDoc(doc(db, "matches", `${user.uid}_${targetId}`), {
        users: [user.uid, targetId],
        createdAt: serverTimestamp(),
      });
    }

    setCurrent((c) => c + 1);
  };

  // üß† Algoritma kecocokan
  const compatibilityScore = (candidate) => {
    if (!candidate) return 0;
    let score = 0;
    if (candidate.city === "Jakarta") score += 30;
    if (candidate.interests?.includes("music")) score += 40;
    if (Math.abs(candidate.age - 25) <= 3) score += 30;
    return Math.min(score, 100);
  };

  // ‚è≥ Loading guard (IMPORTANT FIX)
  if (loading) return <div className="p-4">Loading...</div>;

  // üîê Login UI
  if (!user)
    return (
      <div className="min-h-screen flex flex-col justify-center items-center gap-2">
        <input placeholder="Email" onChange={(e) => setEmail(e.target.value)} />
        <input
          placeholder="Password"
          type="password"
          onChange={(e) => setPassword(e.target.value)}
        />
        <button onClick={login}>Login</button>
        <button onClick={register}>Register</button>
      </div>
    );

  const profile = profiles[current];

  return (
    <div className="min-h-screen p-4">
      <button onClick={() => signOut(auth)}>Logout</button>

      {profile ? (
        <div className="border rounded-xl p-4 mt-4">
          <h2>{profile.email}</h2>
          <p>Usia: {profile.age}</p>
          <p>Kota: {profile.city}</p>
          <p>Skor cocok: {compatibilityScore(profile)}%</p>
          <button onClick={() => likeUser(profile.id)}>‚ù§Ô∏è Suka</button>
          <button onClick={() => setCurrent((c) => c + 1)}>Skip</button>
        </div>
      ) : (
        <h1>Tidak ada profil lagi</h1>
      )}
    </div>
  );
}

// =============================
// üí¨ WhatsApp-style Chat UI
// =============================

export function ChatUI({ messages = [], userId }) {
  return (
    <div className="flex flex-col gap-2 h-96 overflow-y-auto p-2 bg-gray-100 rounded-xl">
      {messages.map((m) => (
        <div
          key={m.id}
          className={`max-w-xs p-2 rounded-xl text-sm ${
            m.from === userId
              ? "self-end bg-green-500 text-white"
              : "self-start bg-white"
          }`}
        >
          {m.text}
        </div>
      ))}
    </div>
  );
}

// =============================
// üß¨ AI Recommendation Engine
// =============================

export function aiRecommendation(user, candidate) {
  if (!user || !candidate) return 0;
  let score = 0;
  score += 100 - Math.abs(user.age - candidate.age) * 5;
  if (user.city === candidate.city) score += 40;
  const sameInterests = user.interests?.filter((i) =>
    candidate.interests?.includes(i)
  ).length;
  score += sameInterests * 20;
  return Math.max(0, Math.min(score, 100));
}

// =============================
// üåç Filters
// =============================

export function filterProfiles(profiles, filters) {
  return profiles.filter((p) => {
    if (filters.minAge && p.age < filters.minAge) return false;
    if (filters.maxAge && p.age > filters.maxAge) return false;
    if (filters.city && p.city !== filters.city) return false;
    if (filters.interest && !p.interests?.includes(filters.interest)) return false;
    return true;
  });
}

// =============================
// üè™ Monetization
// =============================

export const plans = {
  free: { likesPerDay: 10, boost: false },
  premium: { likesPerDay: 100, boost: true },
};

export function applyBoost(profile) {
  return {
    ...profile,
    boostedUntil: Date.now() + 30 * 60 * 1000,
  };

// =============================
// ‚úÖ BASIC RUNTIME TESTS
// =============================

console.assert(typeof aiRecommendation === "function", "AI function missing");
console.assert(plans.premium.boost === true, "Premium plan broken");
      
